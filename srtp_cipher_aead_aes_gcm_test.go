package srtp

import (
	"testing"

	"github.com/stretchr/testify/assert"
)

func TestSrtpCipherAedAesGcm(t *testing.T) {
	decryptedRTPPacket := []byte{
		0x80, 0x0f, 0x12, 0x34, 0xde, 0xca, 0xfb, 0xad,
		0xca, 0xfe, 0xba, 0xbe, 0xab, 0xab, 0xab, 0xab,
		0xab, 0xab, 0xab, 0xab, 0xab, 0xab, 0xab, 0xab,
		0xab, 0xab, 0xab, 0xab,
	}
	encryptedRTPPacket := []byte{
		0x80, 0x0f, 0x12, 0x34, 0xde, 0xca, 0xfb, 0xad,
		0xca, 0xfe, 0xba, 0xbe, 0xa6, 0x2c, 0x7d, 0x60,
		0x03, 0xee, 0x61, 0xd4, 0x3e, 0x9c, 0x1c, 0x92,
		0x2d, 0x8d, 0xe0, 0x96, 0xf3, 0x3d, 0x58, 0x38,
		0xb1, 0x22, 0xd5, 0x3a, 0xd9, 0x93, 0xa1, 0x3c,
		0x90, 0x55, 0x9a, 0x8e,
	}
	decryptedRtcpPacket := []byte{
		0x81, 0xc8, 0x00, 0x0b, 0xca, 0xfe, 0xba, 0xbe,
		0xab, 0xab, 0xab, 0xab, 0xab, 0xab, 0xab, 0xab,
		0xab, 0xab, 0xab, 0xab, 0xab, 0xab, 0xab, 0xab,
	}
	encryptedRtcpPacket := []byte{
		0x81, 0xc8, 0x00, 0x0b, 0xca, 0xfe, 0xba, 0xbe,
		0x29, 0xbe, 0xd9, 0xb2, 0xa7, 0xb5, 0x0f, 0xad,
		0x97, 0x16, 0x6d, 0x41, 0x01, 0x09, 0x08, 0xaf,
		0x65, 0x03, 0xad, 0x95, 0x9c, 0x9d, 0x44, 0xd2,
		0xad, 0xe5, 0x4c, 0x34, 0xb1, 0xcb, 0xec, 0x17,
		0x80, 0x00, 0x00, 0x01,
	}

	masterKey := []byte{0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f}
	masterSalt := []byte{0xa0, 0xa1, 0xa2, 0xa3, 0xa4, 0xa5, 0xa6, 0xa7, 0xa8, 0xa9, 0xaa, 0xab}

	t.Run("Encrypt RTP", func(t *testing.T) {
		ctx, err := CreateContext(masterKey, masterSalt, ProtectionProfileAeadAes128Gcm)
		assert.NoError(t, err)

		t.Run("New Allocation", func(t *testing.T) {
			actualEncrypted, err := ctx.EncryptRTP(nil, decryptedRTPPacket, nil)
			assert.NoError(t, err)
			assert.Equal(t, encryptedRTPPacket, actualEncrypted)
		})
	})

	t.Run("Decrypt RTP", func(t *testing.T) {
		ctx, err := CreateContext(masterKey, masterSalt, ProtectionProfileAeadAes128Gcm)
		assert.NoError(t, err)

		t.Run("New Allocation", func(t *testing.T) {
			actualDecrypted, err := ctx.DecryptRTP(nil, encryptedRTPPacket, nil)
			assert.NoError(t, err)
			assert.Equal(t, decryptedRTPPacket, actualDecrypted)
		})
	})

	t.Run("Encrypt RTCP", func(t *testing.T) {
		ctx, err := CreateContext(masterKey, masterSalt, ProtectionProfileAeadAes128Gcm)
		assert.NoError(t, err)

		t.Run("New Allocation", func(t *testing.T) {
			actualEncrypted, err := ctx.EncryptRTCP(nil, decryptedRtcpPacket, nil)
			assert.NoError(t, err)
			assert.Equal(t, encryptedRtcpPacket, actualEncrypted)
		})
	})

	t.Run("Decrypt RTCP", func(t *testing.T) {
		ctx, err := CreateContext(masterKey, masterSalt, ProtectionProfileAeadAes128Gcm)
		assert.NoError(t, err)

		t.Run("New Allocation", func(t *testing.T) {
			actualDecrypted, err := ctx.DecryptRTCP(nil, encryptedRtcpPacket, nil)
			assert.NoError(t, err)
			assert.Equal(t, decryptedRtcpPacket, actualDecrypted)
		})
	})
}
